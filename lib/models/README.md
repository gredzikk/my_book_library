# Models Directory

This directory contains the data models for the My Book Library application.

## Files

### `database_types.dart`
Auto-generated by Supadart. Contains the core database entity classes:
- `Books` - Represents a book in the database
- `ReadingSessions` - Represents a reading session
- `Genres` - Represents a genre
- `BOOK_STATUS` - Enum for book status values

**Warning**: Do not modify this file manually as it will be overwritten by Supadart.

### `types.dart`
Contains all DTO (Data Transfer Object) and Command Model definitions for API interactions.
These types are built using the Freezed package for immutability and code generation.

## DTOs Overview

### Book DTOs

#### `BookListItemDto`
Response DTO for book list items with embedded genre information.
- **API Endpoint**: `GET /rest/v1/books`
- **Features**: Includes embedded genre name from relation
- **Usage**:
  ```dart
  final books = await supabase.books
    .select('*, genres(name)')
    .withConverter((data) => data.map((e) => BookListItemDto.fromJson(e)).toList());
  ```

#### `BookDetailDto`
Response DTO for single book details (alias of `BookListItemDto`).
- **API Endpoint**: `GET /rest/v1/books?id=eq.{book_id}`

#### `CreateBookDto`
Command DTO for creating a new book.
- **API Endpoint**: `POST /rest/v1/books`
- **Required Fields**: `title`, `author`, `page_count`
- **Optional Fields**: `genre_id`, `cover_url`, `isbn`, `publisher`, `publication_year`
- **Usage**:
  ```dart
  final newBook = CreateBookDto(
    title: 'The Hobbit',
    author: 'J.R.R. Tolkien',
    pageCount: 310,
    genreId: genreId,
  );
  
  await supabase.books.insert(newBook.toRequestJson());
  ```

#### `UpdateBookDto`
Command DTO for updating an existing book.
- **API Endpoint**: `PATCH /rest/v1/books?id=eq.{book_id}`
- **All Fields Optional**: Update only the fields you need
- **Usage**:
  ```dart
  final update = UpdateBookDto(
    status: BOOK_STATUS.finished,
    lastReadPageNumber: 310,
  );
  
  await supabase.books
    .update(update.toRequestJson())
    .eq('id', bookId);
  ```

### Reading Session DTOs

#### `ReadingSessionDto`
Response DTO for reading sessions.
- **API Endpoint**: `GET /rest/v1/reading_sessions`
- **Usage**:
  ```dart
  final sessions = await supabase.reading_sessions
    .select()
    .eq('book_id', bookId)
    .order('created_at', ascending: false)
    .withConverter((data) => data.map((e) => ReadingSessionDto.fromJson(e)).toList());
  ```

#### `EndReadingSessionDto`
Command DTO for ending a reading session via RPC.
- **API Endpoint**: `POST /rest/v1/rpc/end_reading_session`
- **Features**: Automatically calculates duration and pages read, updates book progress
- **Usage**:
  ```dart
  final sessionDto = EndReadingSessionDto(
    bookId: bookId,
    startTime: sessionStart,
    endTime: DateTime.now(),
    lastReadPage: 150,
  );
  
  await supabase.rpc('end_reading_session', params: sessionDto.toRequestJson());
  ```

### Genre DTOs

#### `GenreDto`
Response DTO for genres.
- **API Endpoint**: `GET /rest/v1/genres`
- **Usage**:
  ```dart
  final genres = await supabase.genres
    .select()
    .order('name')
    .withConverter((data) => data.map((e) => GenreDto.fromJson(e)).toList());
  ```

#### `GenreEmbeddedDto`
Embedded genre information in book responses (contains only name field).

## Freezed Package

All DTOs use the Freezed package which provides:
- **Immutability**: All fields are final
- **copyWith**: Create modified copies of objects
- **JSON Serialization**: Automatic `fromJson` and `toJson` methods
- **Equality**: Value-based equality comparison

### Example Usage:

```dart
// Create a DTO
final book = BookListItemDto(
  id: '123',
  userId: 'user-1',
  title: 'Example Book',
  // ... other fields
);

// Create a modified copy
final updatedBook = book.copyWith(
  title: 'Updated Title',
);

// JSON serialization
final json = book.toJson();
final bookFromJson = BookListItemDto.fromJson(json);

// Equality comparison
print(book == updatedBook); // false
```

## Code Generation

The generated files (`types.freezed.dart` and `types.g.dart`) are created by running:

```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

**Note**: Do not modify generated files manually. Always regenerate them after changing `types.dart`.

## Design Principles

1. **Separation of Concerns**: DTOs are separate from database entities
2. **Type Safety**: All DTOs use strong typing and null safety
3. **API Alignment**: Each DTO matches its corresponding API endpoint structure
4. **Convenience**: Factory constructors for easy conversion between entities and DTOs
5. **Validation**: Use `toRequestJson()` methods to ensure only valid fields are sent to the API

